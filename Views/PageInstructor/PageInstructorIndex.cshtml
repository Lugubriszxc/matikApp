<!DOCTYPE html>
<html lang="en">
<header>
    
</header>
<body>
    <nav class="navbar bg-body-tertiary fixed-top">
    <div class="container-fluid">
        @* <a class="navbar-brand text-warning" href="#">M A T I K</a> *@
        <button class="navbar-toggler me-auto btn-black" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
            <span class=""><i class="fa-solid fa-bars text-warning"></i></span>
            
        </button>
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
        <div class="offcanvas-header">
            <center><h5 class="offcanvas-title instructorName" id="offcanvasNavbarLabel">Instructor X</h5></center>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">Home</a>
            </li>
            <li class="nav-item">
                <a class="btn btn-warning" id="btnSignout">Signout</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                User Settings
                </a>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-lg-start">
                <li class="dropdown-item"><a class="nav-link btnUpdate">Change detail</a></li>
                <li class="dropdown-item"><a class="nav-link btnChangePass">Change password</a></li>
                @* <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#">Something else here</a></li> *@
                </ul>
            </li>
            </ul>
            @* <form class="d-flex mt-3" role="search">
            <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success" type="submit">Search</button>
            </form> *@
        </div>
        </div>
    </div>
    </nav>

    <!-- THIS IS FOR THE CONTENT OF THE PAGE-->
    <center><h1>Instructor's Page</h1></center>

    @Html.Partial("PageInstructorUpdate")
    @Html.Partial("InstructorChangePass")

</body>
</html>


<script>
    $(document).ready(function(){



        margin();

        function margin(){
            $(".page-content").removeClass();
            $(".container-fluid.shared").removeClass();
            @* $(".bods").removeClass(); *@
        }
    });
</script>

<style>
    .navbar.shared{
        display: none;
    }

    .bods
    {
        color: white;
        background-color: white;
    }

    .btn-black {
    color: #000;
    background-color: maroon; /* Add this line to set the background color */
    border-color: gold; /* Add this line to set the border color */
    }

    @* body
    {
        color: black;
        background-color: black;
    } *@
</style>


<script>
    $(() => {

        console.log(JSON.parse(sessionStorage.getItem('userauth')));
        var storedUserAuth = sessionStorage.getItem('userauth');
        var userAuth = JSON.parse(storedUserAuth);

        console.log(userAuth.userType);

        if(userAuth === null)
        {
            window.location.href = "/Authorization/SigninInstructor";
        }
        else if(userAuth.userType !== 'instructor')
        {
            if(userAuth.userType === 'admin')
            {
                window.location.href = "/Home/Index";
            }
        }

        var selectedInstructor;

        loadInstructorDetail();
        populateDepartment();

        function loadInstructorDetail()
        {
            //LOAD THE INSTRUCTOR DETAILS 
            $.ajax({
            url: "../api/pageinstructorapi/loadUserDetail",
            type: "POST",
            data:
            {
                instructorId : userAuth.id,
            },
            }).done(function(result){
                
                if(result != null)
                {
                    selectedInstructor = result;
                    //console.log(result.instructorFname);
                    $('.instructorName').text(result.instructorFname + " " + result.instructorLname);
                }
            })
        }

        //to populate the department option 
        function populateDepartment()
        {
            $.ajax("../api/adminapi/getDepartment")
            .done(function(result){
            //console.log(result);
            var template = document.querySelector("template#departmentOptionTemplate");
            var parent = document.querySelectorAll("#departmentSelect");
            
            for(i = 0; i < parent.length; i++){
            result.forEach(function (item){
                var cloned = template.content.cloneNode(true);
                cloned.querySelector("option").value = item.departmentId;
                cloned.querySelector("option").innerText= item.departmentName;

                parent[i].prepend(cloned);
            });
            }

            //to deselect a selected option
            $("select").val([]);
            });
        }


        $(".btnUpdate").click((e) => {
            $("#modalInstructorUpdate").modal("toggle");

            oFormObject = document.forms["updateInstructorForm"];
            initForm(oFormObject, selectedInstructor);
        });

        //to populate the selected element to the form
        function initForm(form, data){
            Object.getOwnPropertyNames(data).forEach(function(item){
            var currentElem = form.elements[item.charAt(0).toUpperCase() + item.slice(1)];
            //console.log(currentElem);
            console.log(currentElem);

            if( currentElem == null ){return;}

            if(currentElem.tagName == "SELECT"){
                var selectChildren = Array.from(currentElem.children);
                var matchedOpt = selectChildren.find(opt => opt.value == selectedInstructor.departmentId);
            if(matchedOpt){
                matchedOpt.selected = true;
            }
            }else{
                form.elements[item.charAt(0).toUpperCase() + item.slice(1)].setAttribute("value",data[item]); 
            }
            });
        }

        //after clicking update
        $("#updateInstructor").click(function(){
            alertSaveChanges();
        });

        function proceedUpdate()
        {
            var arrData = {};

            //count the number of elements inside  the form
            var formelements = $("#updateInstructorForm .form-group");

            //getting the data from the form
            var formInputs = $("#updateInstructorForm").serializeArray();
            formInputs.forEach(function(item){
                arrData[item.name] = item.value;
            });

            arrData.instructorId = selectedInstructor.instructorId;

            let emptyEl = new Boolean(false);
            //alternative of bool
            if(formInputs[0].value === '' || formInputs[2].value === '')
            {
                //if the firstname or lastname are empty then return true or 0
                emptyEl = Boolean(true);
            }
            else{
                //if the firstname and lastname are not empty then return false or 1
                emptyEl = Boolean(false);
            }

            //if all elements are not empty
            if(formInputs.length === formelements.length && emptyEl ===  Boolean(false))
            {
                //Call API to add Instructor
                $.ajax({
                    url: "../api/adminapi/updateInstructor",
                    type: "POST",
                    data:
                    {
                        i : arrData,
                    },
                })
                .done(function(){
                    $("#updateInstructorForm")[0].reset();
                    $("#modalInstructorUpdate").modal("toggle");
                    alertSuccess();
                    loadInstructorDetail();
                });
            }
            else   
            {
                alertError("Input the necessary elements!");
            }
        }

        $(".btnChangePass").click((e) => {
            $("#modalChangePass").modal("toggle");
        });

        //after clicking change password
        $("#passChange").click(function(){

            var currentPass = $("#inputCurrentPass").val();
            var newPass = $("#inputNewPass").val();
            var confirmPass = $("#inputConfirmPass").val();

            if(currentPass == "" || newPass == "" || confirmPass == "")
            {
                alertError("Complete the field first!");
            }
            else if(newPass !== confirmPass)
            {
                alertError("Password does not match!");
            }
            else
            {
                alertConfirmChange();
            }
        });

        function proceedChangePass()
        {

            var currentPass = $("#inputCurrentPass").val();
            var newPass = $("#inputNewPass").val();
            var confirmPass = $("#inputConfirmPass").val();
            
            $.ajax({
            url: "../api/authorizationapi/changeUserPass",
            type: "POST",
            data:
            {
                auth : userAuth,
                newP : newPass,
                currentP : currentPass,
            },
            })
            .done(function(result){
                @* $("#updateInstructorForm")[0].reset();
                $("#modalInstructorUpdate").modal("toggle");
                alertSuccess();
                loadInstructorDetail(); *@

                if(result == "Invalid")
                {
                    alertError("Invalid password.");
                }
                else if(result == "Confirm")
                {
                    $("#passChangeForm")[0].reset();
                    $("#modalChangePass").modal("toggle");
                    alertSuccess();
                    loadInstructorDetail();
                }
            });
        }


        $("#btnSignout").click((e) =>{
            confirmLogout();
        });

        function proceedLogout()
        {
            @* $.ajax("../api/authorizationapi/logoutUser")
            .done(function(){
                window.location.href = "/Authorization/SigninInstructor";
            }); *@
            sessionStorage.clear();
            window.location.href = "/Authorization/SigninInstructor";
        }


        //display update confirmation
        function confirmLogout()
        {
            Swal.fire({
                title: 'Are you sure you want to logout?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes',
                confirmButtonColor: '#3085d6'
            }).then((result) => {
                if(result.isConfirmed){
                    proceedLogout();
                }
            })
        }

        //display update confirmation
        function alertSaveChanges()
        {
            Swal.fire({
                title: 'Do you want to save the changes?',
                showCancelButton: true,
                confirmButtonText: 'Save',
            }).then((result) => {
                if(result.isConfirmed){
                    proceedUpdate();
                }
            })
        }

        //display confirm change password
        function alertConfirmChange()
        {
            Swal.fire({
                title: 'Do you really want to change your password?',
                showCancelButton: true,
                confirmButtonText: 'Save',
            }).then((result) => {
                if(result.isConfirmed){
                    proceedChangePass();
                }
            })
        }

        //display success action
        function alertSuccess()
        {
            Swal.fire({
                icon: 'success',
                title: 'Your work has been saved', 
                showConfirmButton: false,
                timer: 1500
            })
        }

        function alertError(message)
        {
            Swal.fire({
                icon: 'error',
                title: 'Error occured',
                text: message,
            })
        }

        //End of document
    });
</script>